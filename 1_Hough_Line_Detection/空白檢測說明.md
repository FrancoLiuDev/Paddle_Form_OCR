# 空白分隔線檢測功能

## 功能說明

這個功能可以自動檢測文件中的空白分隔線，並用綠色標記出來。主要用於表單結構分析。

## 工作流程

1. **線條檢測** - 首先使用 Hough 直線檢測找出文件中的線條
2. **角度統計** - 計算線條的角度分布，找出最常見的角度（眾數）
3. **空白掃描** - 沿著最常見角度的方向（±5度）掃描文件
4. **區域識別** - 找出連續出現白色像素的區域
5. **標記輸出** - 用綠色線條標記空白分隔區域

## 使用方法

### 基本用法

```bash
# 檢測角度 ±10度範圍內的線條，然後檢測空白分隔線
python3 preprocess_hough.py \
    --input ../fuji.png \
    --output result.jpg \
    --show-lines \
    --degree 10 \
    --detect-blanks
```

### 進階參數

```bash
# 自訂掃描參數
python3 preprocess_hough.py \
    --input ../fuji.png \
    --output result.jpg \
    --show-lines \
    --degree 10 \
    --detect-blanks \
    --min-blank 50 \          # 最小空白長度 50px
    --scan-step 2 \           # 掃描間隔 2px（更精細）
    --white-threshold 230     # 白色閾值 230（更寬鬆）
```

## 參數說明

### 線條檢測參數

- `--show-lines`: 啟用線條可視化模式
- `--degree <角度>`: 限制線條角度範圍（例如：`--degree 10` 只顯示 ±10° 內的線條）

### 空白檢測參數

- `--detect-blanks`: 啟用空白分隔線檢測
- `--min-blank <像素>`: 最小空白長度（預設：30）
  - 較小的值：檢測更多細小的空白
  - 較大的值：只檢測主要的空白分隔線
  
- `--scan-step <像素>`: 掃描間隔（預設：5）
  - 較小的值：掃描更精細，但速度較慢
  - 較大的值：掃描更快，但可能遺漏某些空白區域
  
- `--white-threshold <0-255>`: 白色閾值（預設：240）
  - 較高的值（接近255）：只識別非常白的區域
  - 較低的值（例如200）：也識別淺灰色區域為空白

## 輸出檔案

執行後會生成兩個檔案：

1. `{輸出名}_lines.jpg` - 紅色線條標記的檢測結果
2. `{輸出名}_blanks.jpg` - 綠色線條標記的空白分隔線

例如：`--output result.jpg` 會生成：
- `result_lines.jpg` - 線條檢測結果
- `result_blanks.jpg` - 空白檢測結果

## 使用範例

### 範例 1: 表單欄位分隔線檢測

```bash
# 檢測水平的空白分隔線（適合橫向表單）
python3 preprocess_hough.py \
    --input form.png \
    --output form_result.jpg \
    --show-lines \
    --degree 10 \
    --detect-blanks \
    --min-blank 100
```

### 範例 2: 精細掃描

```bash
# 更精細的掃描，檢測較小的空白區域
python3 preprocess_hough.py \
    --input document.png \
    --output document_result.jpg \
    --show-lines \
    --degree 5 \
    --detect-blanks \
    --min-blank 20 \
    --scan-step 2
```

### 範例 3: 垂直分隔線檢測

```bash
# 檢測垂直的空白分隔線（適合縱向表單）
python3 preprocess_hough.py \
    --input vertical_form.png \
    --output vertical_result.jpg \
    --show-lines \
    --degree 10  # 這會自動偵測垂直線並相應掃描
    --detect-blanks
```

## 輸出說明

### 終端輸出範例

```
=== 線條檢測可視化 ===
  角度過濾: ±10.0°
  檢測到 187 條線
  符合角度範圍 (±10.0°) 的線: 18 條

  過濾後角度統計:
  最常見的角度:               0.00° (出現 17 次)

=== 空白分隔線檢測 ===
  掃描角度: 0.00° (±5.0°)
  掃描方向: 垂直掃描（逐行檢查水平空白線）
  
  檢測到 140 個空白分隔區域
  1. 水平空白區 at y=22 (範圍:0-45), x=[0-678], 長度=678px
  2. 水平空白區 at y=75 (範圍:60-91), x=[0-95], 長度=95px
  ...
```

### 解讀輸出

- `y=22 (範圍:0-45)`: 在第 22 行處標記，實際空白區域從第 0 行到第 45 行
- `x=[0-678]`: 這個空白區域橫跨整個圖像寬度
- `長度=678px`: 連續空白的長度為 678 像素

## 工作原理

### 水平線檢測模式（角度接近 0° 或 180°）

1. 計算每一行的白色像素比例
2. 找出連續的空白行區域（白色比例 > 90%）
3. 在每個空白行區域的中間位置掃描
4. 標記出連續的水平空白線

### 垂直線檢測模式（角度接近 90° 或 -90°）

1. 計算每一列的白色像素比例
2. 找出連續的空白列區域（白色比例 > 90%）
3. 在每個空白列區域的中間位置掃描
4. 標記出連續的垂直空白線

## 注意事項

1. **必須先啟用 `--show-lines`** 才能使用 `--detect-blanks`
2. **角度偵測** 會自動選擇最常見的線條角度作為掃描方向
3. **目前只支援接近水平或垂直的角度**（±10度範圍內）
4. 掃描參數需要根據文件類型調整
   - 高解析度文件：增加 `--min-blank` 和 `--scan-step`
   - 低解析度文件：減少 `--min-blank`，使用較小的 `--scan-step`

## 應用場景

- 📋 表單結構分析
- 📑 文件欄位切割
- 🗂️ 表格識別預處理
- 📊 文本區域分割
- 🎯 OCR 預處理優化
