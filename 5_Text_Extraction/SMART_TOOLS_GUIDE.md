# ğŸ¤– æ™ºèƒ½æ¬„ä½åˆ†æå·¥å…·

## æ¦‚è¿°

é€™äº›å·¥å…·å¯ä»¥å¹«åŠ©ä½ **è‡ªå‹•æ¨æ¸¬å’Œç†è§£ OCR æ–‡å­—çš„çœŸæ­£å«ç¾©**ï¼Œå³ä½¿æœ‰éŒ¯å­—ã€æ¼å­—ä¹Ÿèƒ½æ­£ç¢ºè­˜åˆ¥ã€‚

## ğŸ› ï¸ å¯ç”¨å·¥å…·

### 1. æ¨¡ç³ŠåŒ¹é… (Fuzzy Matching)

**ç”¨é€”**: å®¹å¿ OCR éŒ¯å­—ã€æ¼å­—

**åŸç†**: è¨ˆç®—å­—ä¸²ç›¸ä¼¼åº¦ (0-1)ï¼Œå³ä½¿ä¸å®Œå…¨ç›¸åŒä¹Ÿèƒ½æ‰¾åˆ°

**ç¯„ä¾‹**:
```python
from difflib import SequenceMatcher

target = "ç¸½å°å¼µæ•¸"
text = "å°å¼ æ•°"
similarity = SequenceMatcher(None, text, target).ratio()
# ç›¸ä¼¼åº¦: 0.67 (67%) â†’ å¯ä»¥åŒ¹é…ï¼
```

**å„ªé»**:
- âœ… è™•ç† OCR æ¼å­—ï¼ˆ"ç¸½å°å¼µæ•¸" â†’ "å°å¼ æ•°"ï¼‰
- âœ… è™•ç†éŒ¯åˆ¥å­—ï¼ˆ"å°è¡¨æ©Ÿåç¨±" â†’ "å°è¡¨æ©Ÿåç¨ "ï¼‰
- âœ… ä¸éœ€è¦é å…ˆçŸ¥é“æ‰€æœ‰å¯èƒ½çš„è®Šé«”

**ä½¿ç”¨å ´æ™¯**:
- OCR å“è³ªä¸ç©©å®š
- æ¬„ä½åç¨±å¯èƒ½æœ‰å¤šç¨®å¯«æ³•
- æƒ³è¦å¿«é€Ÿæœå°‹ç›¸ä¼¼æ–‡å­—

---

### 2. èªç¾©é—œéµå­—æœå°‹ (Semantic Keywords)

**ç”¨é€”**: ç”¨æ¦‚å¿µå’Œç›¸é—œé—œéµå­—æ“´å¤§æœå°‹ç¯„åœ

**åŸç†**: æº–å‚™å¤šå€‹åŒç¾©è©ã€ç°¡ç¹é«”ã€ç¸®å¯«ç­‰é—œéµå­—åˆ—è¡¨

**ç¯„ä¾‹**:
```python
# æœå°‹ã€Œåºè™Ÿã€é€™å€‹æ¦‚å¿µ
keywords = [
    'åºè™Ÿ', 'åºå·',      # ç¹ç°¡é«”
    'åºèµ‹',              # OCR èª¤èª
    'åºåˆ—è™Ÿ', 'ç¼–å·',    # åŒç¾©è©
    'Serial', 'SN'       # è‹±æ–‡
]

# åªè¦åŒ¹é…åˆ°ä»»ä½•ä¸€å€‹å°±ç®—æˆåŠŸ
for keyword in keywords:
    if keyword in text:
        return True
```

**å„ªé»**:
- âœ… æé«˜åŒ¹é…æˆåŠŸç‡
- âœ… è™•ç†ç°¡ç¹æ··ç”¨
- âœ… è™•ç†åŒç¾©è©ã€åˆ¥å
- âœ… æ”¯æ´ä¸­è‹±æ··åˆ

**ä½¿ç”¨å ´æ™¯**:
- æ¬„ä½åç¨±æœ‰å¤šç¨®è¡¨é”æ–¹å¼
- ç°¡ç¹é«”æ··ç”¨çš„æ–‡ä»¶
- éœ€è¦æ”¯æ´å¤šèªè¨€

---

### 3. æ¨¡å¼è­˜åˆ¥ (Pattern Recognition)

**ç”¨é€”**: è‡ªå‹•è­˜åˆ¥ç‰¹å®šæ ¼å¼çš„è³‡æ–™

**åŸç†**: ä½¿ç”¨æ­£å‰‡è¡¨é”å¼åŒ¹é…å¸¸è¦‹æ ¼å¼

**ç¯„ä¾‹**:
```python
import re

patterns = {
    'é æ•¸': r'\d+\s*[é é¡µ]',           # 1250é , 294é¡µ
    'åºè™Ÿ': r'[A-Z]{2}\d{7,}',        # NC7003677
    'æ—¥æœŸ': r'\d{4}[/-]\d{2}[/-]\d{2}', # 2024/12/08
    'IPä½å€': r'\d{1,3}(\.\d{1,3}){3}', # 192.168.1.1
    'æ™‚é–“': r'\d{1,2}:\d{2}',         # 14:30
    'é›»è©±': r'\d{2,4}-\d{3,4}-\d{4}',  # 02-1234-5678
}

# è‡ªå‹•æ‰¾å‡ºæ‰€æœ‰ç¬¦åˆæ ¼å¼çš„æ–‡å­—
for block in text_blocks:
    if re.search(patterns['é æ•¸'], block['text']):
        print(f"æ‰¾åˆ°é æ•¸: {block['text']}")
```

**å„ªé»**:
- âœ… ä¸éœ€è¦çŸ¥é“æ¬„ä½åç¨±
- âœ… è‡ªå‹•è­˜åˆ¥çµæ§‹åŒ–è³‡æ–™
- âœ… å¯ä»¥é©—è­‰è³‡æ–™æ ¼å¼æ­£ç¢ºæ€§
- âœ… æå–æ•¸å­—ã€æ—¥æœŸç­‰ç‰¹å®šè³‡è¨Š

**ä½¿ç”¨å ´æ™¯**:
- æå–æ•¸å­—ã€æ—¥æœŸã€æ™‚é–“
- é©—è­‰æ ¼å¼æ­£ç¢ºæ€§ï¼ˆåºè™Ÿã€é›»è©±ç­‰ï¼‰
- ä¸ç¢ºå®šæ¬„ä½åç¨±ï¼Œä½†çŸ¥é“å€¼çš„æ ¼å¼

---

### 4. ä½ç½®é—œä¿‚åˆ†æ (Position Analysis)

**ç”¨é€”**: æ ¹æ“šåº§æ¨™æ¨æ¸¬æ¬„ä½èˆ‡å€¼çš„å°æ‡‰é—œä¿‚

**åŸç†**: åˆ†ææ–‡å­—å€å¡Šçš„ bbox åº§æ¨™ï¼Œæ‰¾å‡ºç©ºé–“é—œä¿‚

**ç¯„ä¾‹**:
```python
# æ¬„ä½ä½ç½®
field_bbox = [[103, 181], [142, 181], [142, 192], [103, 192]]
field_x = 142  # å³é‚Šç•Œ
field_y = 186  # ä¸­å¿ƒ y

# å°‹æ‰¾å³é‚ŠåŒä¸€è¡Œçš„æ–‡å­—
for block in text_blocks:
    bbox = block['bbox']
    x = bbox[0][0]  # å·¦é‚Šç•Œ
    y = (bbox[0][1] + bbox[2][1]) / 2  # ä¸­å¿ƒ y
    
    # åœ¨å³é‚Š ä¸” y åº§æ¨™æ¥è¿‘ï¼ˆåŒä¸€è¡Œï¼‰
    if x > field_x and abs(y - field_y) < 20:
        print(f"æ‰¾åˆ°å°æ‡‰å€¼: {block['text']}")
        break
```

**ä½ç½®é—œä¿‚**:
- **right**: åœ¨å³é‚Šï¼ˆè¡¨æ ¼ä¸­å¸¸è¦‹ï¼šæ¬„ä½ï½œå€¼ï¼‰
- **below**: åœ¨ä¸‹æ–¹ï¼ˆè¡¨å–®ä¸­å¸¸è¦‹ï¼šæ¬„ä½åœ¨ä¸Šã€å€¼åœ¨ä¸‹ï¼‰
- **above**: åœ¨ä¸Šæ–¹
- **left**: åœ¨å·¦é‚Š

**å„ªé»**:
- âœ… é©ç”¨æ–¼è¡¨æ ¼ã€è¡¨å–®çµæ§‹
- âœ… ä¸ä¾è³´æ–‡å­—å…§å®¹
- âœ… å¯ä»¥è™•ç†æ²’æœ‰æ˜ç¢ºæ¬„ä½åç¨±çš„æƒ…æ³
- âœ… å»ºç«‹æ¬„ä½-å€¼çš„é…å°é—œä¿‚

**ä½¿ç”¨å ´æ™¯**:
- è¡¨æ ¼è³‡æ–™æå–
- è¡¨å–®è³‡æ–™æå–
- æ¬„ä½å’Œå€¼åˆ†é–‹çš„æƒ…æ³

---

### 5. ä¸Šä¸‹æ–‡åˆ†æ (Context Analysis)

**ç”¨é€”**: åˆ†æç›®æ¨™æ–‡å­—å‘¨åœçš„å…§å®¹ï¼Œç†è§£å«ç¾©

**åŸç†**: æŸ¥çœ‹å‰å¾Œ N å€‹æ–‡å­—å€å¡Šï¼Œåˆ†æä¸Šä¸‹æ–‡

**ç¯„ä¾‹**:
```python
def analyze_context(index, window=3):
    """åˆ†æå‰å¾Œå„ 3 å€‹æ–‡å­—å€å¡Š"""
    before = text_blocks[index-3:index]
    target = text_blocks[index]
    after = text_blocks[index+1:index+4]
    
    return {
        'before': [b['text'] for b in before],
        'target': target['text'],
        'after': [a['text'] for a in after]
    }

# ç¯„ä¾‹è¼¸å‡º
{
    'before': ['FUJIFILM', 'ApeosC325', '5dw'],
    'target': 'å°è¡¨åç¨ ',
    'after': ['Aps C325/328 dw', 'U.', 'å°å¼ æ•°']
}
```

**å„ªé»**:
- âœ… ç†è§£æ–‡å­—çš„èªå¢ƒ
- âœ… è¼”åŠ©åˆ¤æ–·æ–‡å­—çš„å«ç¾©
- âœ… å¯ä»¥ç™¼ç¾ç›¸é„°è³‡æ–™çš„é—œè¯
- âœ… å¹«åŠ©é™¤éŒ¯å’Œé©—è­‰

**ä½¿ç”¨å ´æ™¯**:
- ä¸ç¢ºå®šæ–‡å­—å«ç¾©æ™‚
- éœ€è¦ç†è§£è³‡æ–™çµæ§‹æ™‚
- é™¤éŒ¯æå–é‚è¼¯æ™‚

---

## ğŸ¯ æ•´åˆæ‡‰ç”¨ï¼šæ™ºèƒ½æå–

çµåˆå¤šç¨®ç­–ç•¥ï¼Œè‡ªå‹•é¸æ“‡æœ€ä½³æ–¹æ³•ï¼š

```python
from smart_field_detector import SmartFieldDetector

detector = SmartFieldDetector('result.json')

# æ™ºèƒ½æå–ï¼šè‡ªå‹•å˜—è©¦å¤šç¨®ç­–ç•¥
result = detector.smart_extract(
    'å°è¡¨æ©Ÿåç¨±',
    hints={
        'keywords': ['å°è¡¨æ©Ÿåç¨±', 'å°è¡¨åç¨±', 'åç¨±'],  # èªç¾©æœå°‹
        'fuzzy_threshold': 0.6,                         # æ¨¡ç³ŠåŒ¹é…é–€æª»
        'position': 'right',                            # å€¼åœ¨å³é‚Š
        'pattern': 'model'                              # é æœŸæ ¼å¼
    }
)

if result['found']:
    print(f"æ¬„ä½: {result['best_match']['field']['text']}")
    print(f"å€¼: {result['best_match']['value']['text']}")
    print(f"ç­–ç•¥: {result['strategies_used']}")
```

**ç­–ç•¥é¸æ“‡é †åº**:
1. å…ˆå˜—è©¦èªç¾©é—œéµå­—æœå°‹ï¼ˆå¿«é€Ÿã€æº–ç¢ºï¼‰
2. è‹¥å¤±æ•—ï¼Œä½¿ç”¨æ¨¡ç³ŠåŒ¹é…ï¼ˆå®¹éŒ¯ï¼‰
3. è‹¥å¤±æ•—ï¼Œä½¿ç”¨æ¨¡å¼è­˜åˆ¥ï¼ˆåƒ…æ ¹æ“šæ ¼å¼ï¼‰
4. ä½¿ç”¨ä½ç½®åˆ†ææ‰¾å°æ‡‰å€¼
5. é©—è­‰çµæœåˆç†æ€§

---

## ğŸ“Š å·¥å…·æ¯”è¼ƒ

| å·¥å…· | å„ªé» | ç¼ºé» | é©ç”¨å ´æ™¯ |
|------|------|------|----------|
| **æ¨¡ç³ŠåŒ¹é…** | å®¹éŒ¯èƒ½åŠ›å¼· | å¯èƒ½èª¤åˆ¤ | OCR å“è³ªä¸ç©©å®š |
| **èªç¾©æœå°‹** | æº–ç¢ºåº¦é«˜ | éœ€è¦é å…ˆæº–å‚™é—œéµå­— | å·²çŸ¥æ¬„ä½åç¨± |
| **æ¨¡å¼è­˜åˆ¥** | è‡ªå‹•åŒ–ç¨‹åº¦é«˜ | ç„¡æ³•è­˜åˆ¥éçµæ§‹åŒ–è³‡æ–™ | æ•¸å­—ã€æ—¥æœŸç­‰æ ¼å¼åŒ–è³‡æ–™ |
| **ä½ç½®åˆ†æ** | ä¸ä¾è³´æ–‡å­— | éœ€è¦ç©©å®šçš„ç‰ˆé¢ | è¡¨æ ¼ã€è¡¨å–® |
| **ä¸Šä¸‹æ–‡åˆ†æ** | ç†è§£èªå¢ƒ | è¨ˆç®—é‡å¤§ | è¤‡é›œèªç¾©ç†è§£ |

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. çµ„åˆä½¿ç”¨å¤šç¨®å·¥å…·

```python
# ç­–ç•¥ 1: èªç¾©æœå°‹ + ä½ç½®åˆ†æ
field = semantic_search('ç¸½å°å¼µæ•¸', ['å°å¼ æ•°'])
value = find_value_by_position(field, 'right')

# ç­–ç•¥ 2: æ¨¡ç³ŠåŒ¹é… + æ¨¡å¼é©—è­‰
field = fuzzy_match('ç¸½å°å¼µæ•¸', threshold=0.6)
if recognize_pattern(field.value, 'page'):  # é©—è­‰æ˜¯é æ•¸æ ¼å¼
    print("ç¢ºèªæ‰¾åˆ°æ­£ç¢ºçš„å€¼")
```

### 2. è¨­å®šåˆç†çš„é–€æª»

```python
# æ¨¡ç³ŠåŒ¹é…é–€æª»
- 0.9-1.0: å¹¾ä¹å®Œå…¨ç›¸åŒ
- 0.7-0.9: ç›¸ä¼¼åº¦é«˜ï¼ˆæ¨è–¦ï¼‰
- 0.5-0.7: å®¹éŒ¯ç¯„åœï¼ˆå¯èƒ½èª¤åˆ¤ï¼‰
- 0.0-0.5: å·®ç•°å¤ªå¤§
```

### 3. å»ºç«‹é—œéµå­—åº«

```python
# ç³»çµ±åŒ–æ•´ç†é—œéµå­—
field_keywords = {
    'å°è¡¨æ©Ÿå‹è™Ÿ': {
        'zh-TW': ['å°è¡¨æ©Ÿåç¨±', 'æ©Ÿå‹'],
        'zh-CN': ['æ‰“å°æœºåç§°', 'å‹å·'],
        'en': ['Model', 'Printer Name'],
        'ocr_errors': ['å°è¡¨åç¨ ', 'å°è¡¨æ©Ÿåç¨ ']  # å¸¸è¦‹ OCR éŒ¯èª¤
    }
}
```

### 4. é©—è­‰æå–çµæœ

```python
# æå–å¾Œé©—è­‰
result = extract_field('ç¸½å°å¼µæ•¸')

# é©—è­‰ 1: æª¢æŸ¥æ ¼å¼
if not re.match(r'\d+\s*[é é¡µ]', result):
    print("âš ï¸ æ ¼å¼ä¸ç¬¦åˆé æœŸ")

# é©—è­‰ 2: æª¢æŸ¥ç¯„åœ
pages = int(re.findall(r'\d+', result)[0])
if pages > 10000:
    print("âš ï¸ æ•¸å­—ç•°å¸¸å¤§")

# é©—è­‰ 3: æª¢æŸ¥ä¿¡å¿ƒåº¦
if confidence < 0.8:
    print("âš ï¸ OCR ä¿¡å¿ƒåº¦è¼ƒä½")
```

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### åŸºæœ¬ä½¿ç”¨

```bash
# 1. ä½¿ç”¨ç°¡å–®ç¤ºç¯„
cd 5_Text_Extraction
python3 demo_smart_tools.py

# 2. ä½¿ç”¨å®Œæ•´é¡åˆ¥
python3 -c "
from smart_field_detector import SmartFieldDetector
detector = SmartFieldDetector('result.json')
result = detector.smart_extract('å°è¡¨æ©Ÿåç¨±')
print(result)
"
```

### æ•´åˆåˆ°ä½ çš„å°ˆæ¡ˆ

```python
# åœ¨ extract_fuji_fields.py ä¸­ä½¿ç”¨
from smart_field_detector import SmartFieldDetector

detector = SmartFieldDetector(json_file)

# ä½¿ç”¨æ™ºèƒ½æå–æ›¿ä»£æ‰‹å‹•é—œéµå­—åˆ—è¡¨
for field_name in ['å°è¡¨æ©Ÿåç¨±', 'ç¸½å°å¼µæ•¸', 'åºè™Ÿ']:
    result = detector.smart_extract(field_name)
    if result['found']:
        print(f"{field_name}: {result['best_match']['value']['text']}")
```

---

## ğŸ“š å»¶ä¼¸é–±è®€

- **æ¨¡ç³ŠåŒ¹é…**: Python `difflib` æ¨¡çµ„
- **æ­£å‰‡è¡¨é”å¼**: Python `re` æ¨¡çµ„
- **æ›´é€²éš**: 
  - NLP è‡ªç„¶èªè¨€è™•ç†
  - æ©Ÿå™¨å­¸ç¿’åˆ†é¡å™¨
  - å¤§å‹èªè¨€æ¨¡å‹ (LLM) èªç¾©ç†è§£

---

## âœ¨ ç¸½çµ

é€™äº›å·¥å…·å¯ä»¥å¹«åŠ©ä½ ï¼š

1. ğŸ”¤ **è™•ç† OCR éŒ¯èª¤** - æ¨¡ç³ŠåŒ¹é…å®¹å¿éŒ¯å­—æ¼å­—
2. ğŸ” **æé«˜åŒ¹é…ç‡** - èªç¾©æœå°‹ç”¨å¤šå€‹é—œéµå­—
3. ğŸ¯ **è‡ªå‹•è­˜åˆ¥æ ¼å¼** - æ¨¡å¼è­˜åˆ¥æå–çµæ§‹åŒ–è³‡æ–™
4. ğŸ“ **ç†è§£ç‰ˆé¢çµæ§‹** - ä½ç½®åˆ†æå»ºç«‹æ¬„ä½é—œè¯
5. ğŸ§  **æ™ºèƒ½æ±ºç­–** - æ•´åˆç­–ç•¥è‡ªå‹•é¸æ“‡æœ€ä½³æ–¹æ³•

**ä¸å†åªæ˜¯ã€ŒçŒœæƒ³ã€ï¼Œè€Œæ˜¯æœ‰ç³»çµ±ã€æœ‰ç­–ç•¥çš„æ™ºèƒ½åˆ†æï¼** ğŸš€
